{% extends 'base.html' %}

{% block content %}
<div class="container"> <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Tools</h1>
        <div>

            <!-- Search Form -->
            <form method="GET" action="/" class="d-inline ms-3">
                <input type="text" name="search" class="form-control dark-input" placeholder="Search..."
                       value="{{ search | default('') }}">
            </form>

            <!-- Add New Tool Button -->
            <a href="/create/" class="btn btn-success">Add New Tool</a>
        </div>

    </div>

    <!-- Filters -->
    {% include 'filters.html' %}

    <!-- Main content area (table) -->
    <div class="content">
        <table class="table table-dark table-hover">
            <thead>
            <tr>
                <th>
                    <a href="/?sort_by=id&order={{ 'desc' if order == 'asc' else 'asc' }}">ID</a>
                    {% if sort_by == 'id' %}
                    <span>{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}</span>
                    {% endif %}
                </th>
                <th>
                    <a href="/?sort_by=name&order={{ 'desc' if order == 'asc' else 'asc' }}">Name</a>
                    {% if sort_by == 'name' %}
                    <span>{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}</span>
                    {% endif %}
                </th>
                <th>
                    <a href="/?sort_by=diameter&order={{ 'desc' if order == 'asc' else 'asc' }}">Diameter</a>
                    {% if sort_by == 'diameter' %}
                    <span>{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}</span>
                    {% endif %}
                </th>
                <th>
                    <a href="/?sort_by=length&order={{ 'desc' if order == 'asc' else 'asc' }}">Length</a>
                    {% if sort_by == 'length' %}
                    <span>{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}</span>
                    {% endif %}
                </th>
                <th>
                    <a href="/?sort_by=deep_of_drill&order={{ 'desc' if order == 'asc' else 'asc' }}">Deep of Drill</a>
                    {% if sort_by == 'deep_of_drill' %}
                    <span>{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}</span>
                    {% endif %}
                </th>
                <th>
                    <a href="/?sort_by=plate&order={{ 'desc' if order == 'asc' else 'asc' }}">Plate</a>
                    {% if sort_by == 'plate' %}
                    <span>{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}</span>
                    {% endif %}
                </th>
                <th>
                    <a href="/?sort_by=screws&order={{ 'desc' if order == 'asc' else 'asc' }}">Screws</a>
                    {% if sort_by == 'screws' %}
                    <span>{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}</span>
                    {% endif %}
                </th>
                <th>
                    <a href="/?sort_by=key&order={{ 'desc' if order == 'asc' else 'asc' }}">Key</a>
                    {% if sort_by == 'key' %}
                    <span>{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}</span>
                    {% endif %}
                </th>
                <th>
                    <a href="/?sort_by=company&order={{ 'desc' if order == 'asc' else 'asc' }}">Company</a>
                    {% if sort_by == 'company' %}
                    <span>{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}</span>
                    {% endif %}
                </th>
                <th>
                    <a href="/?sort_by=is_broken&order={{ 'desc' if order == 'asc' else 'asc' }}">Broken</a>
                    {% if sort_by == 'is_broken' %}
                    <span>{{ '‚ñ≤' if order == 'asc' else '‚ñº' }}</span>
                    {% endif %}
                </th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for tool in tools %}
            <tr>
                <td>{{ tool.id }}</td>
                <td>{{ tool.name | default('N/A') }}</td>
                <td>{{ tool.diameter | default('N/A') }}</td>
                <td>{{ tool.length | default('N/A') }}</td>
                <td>{{ tool.deep_of_drill if tool.deep_of_drill else '' }}</td>
                <td>{{ tool.plate | default('N/A') }}</td>
                <td>{{ tool.screws if tool.screws  else ''}}</td>
                <td>{{ tool.key if tool.key else ''}}</td>
                <td>{{ tool.company if tool.company else '' }}</td>
                <!--                <td>{{ 'Yes' if tool.is_broken else 'No' }}</td>-->
                <!-- Checkbox –¥–ª—è –ø–æ–ª—è "is_broken" -->
                <td>
                    <input type="checkbox" class="form-check-input is-broken-checkbox"
                           data-tool-id="{{ tool.id }}" {% if tool.is_broken %} checked {% endif %}>
                </td>

                <td>
                    <a href="/update/{{ tool.id }}" class="btn btn-warning btn-sm">‚úèÔ∏è</a>
                    <form method="POST" action="/delete/{{ tool.id }}" class="d-inline">
                        <button type="submit" class="btn btn-danger btn-sm">üóëÔ∏è</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- JavaScript for filter behavior -->
<script>

<!--    document.getElementById('diameter-select').addEventListener('change', function() {-->
<!--        document.getElementById('diameter-filter-form').submit();-->
<!--    });-->

<!--    // Add checkmarks to selected options-->
<!--    const selectElement = document.getElementById('diameter-select');-->
<!--    for (let option of selectElement.options) {-->
<!--        option.textContent = option.selected ? '‚úî ' + option.value : option.value;-->
<!--    }-->

<!--    // Update checkmarks when options are clicked-->
<!--    selectElement.addEventListener('click', function() {-->
<!--        for (let option of selectElement.options) {-->
<!--            option.textContent = option.selected ? '‚úî ' + option.value : option.value;-->
<!--        }-->
<!--    });-->


        document.querySelectorAll('.is-broken-checkbox').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const toolId = this.getAttribute('data-tool-id');
            const isBroken = this.checked;

            // –í—ã–ø–æ–ª–Ω—è–µ–º AJAX-–∑–∞–ø—Ä–æ—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –≤ –±–∞–∑–µ
            fetch(`/update_broken_status/${toolId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'  // –î–æ–±–∞–≤—å—Ç–µ CSRF-—Ç–æ–∫–µ–Ω, –µ—Å–ª–∏ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ
                },
                body: JSON.stringify({ is_broken: isBroken })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Status updated successfully');
                } else {
                    console.error('Failed to update status');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    });
</script>
{% endblock %}
